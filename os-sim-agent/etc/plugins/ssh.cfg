;; ssh
;; plugin_id: 4003
;; type: detector 
;; description: Ssh (Secure Shell) is a program for logging into a remote machine
;;              and for executing commands on a remote machine.
;; URL: http://www.openssh.com
;;
;; $Id: ssh.cfg,v 1.5 2007/02/05 20:09:34 dmitribel Exp $

[DEFAULT]
plugin_id=4003

[config]
type=detector
enable=yes

source=log
location=/var/log/auth.log

# create log file if it does not exists, 
# otherwise stop processing this plugin
create_file=false

process=sshd
start=no   
stop=no
startup=/etc/init.d/ssh start
shutdown=/etc/init.d/ssh stop


## rules

##
## Failed login attempts
##

[ssh - Failed password]
# Feb  8 10:09:06 golgotha sshd[24472]: Failed password for dgil from 192.168.6.69 port 33992 ssh2
event_type=event
regexp="(\S+\s+\d+\s+\d\d:\d\d:\d\d)\s+(?P<sensor>[^\s]*).*?ssh.*?Failed password for (?P<user>\S+)\s+.*?(?P<src>\IPV4).*?port\s+(?P<sport>\PORT)"
plugin_sid=1
sensor={resolv($sensor)}
date={normalize_date($1)}
src_ip={$src}
src_port={$sport}
username={$user}


[ssh - Failed publickey]
# Sep 15 11:29:17 devel-host sshd[18163]: Failed publickey for invalid user fred from 192.168.2.2 port 62788 ssh2 
event_type=event
regexp="(\S+\s+\d+\s+\d\d:\d\d:\d\d)\s+(?P<sensor>[^\s]*).*?ssh.*?Failed publickey for invalid (?P<user>\S+)\s+.*?(?P<src>\IPV4).*?port\s+(?P<sport>\PORT)"
plugin_sid=2
sensor={resolv($sensor)}
src_ip={$src}
src_port={$sport}
username={$user}


[ssh - Invalid user]
# Sep  6 11:04:02 ossim-devel sshd[6983]: Invalid user test123 from
# 10.222.14.27
event_type=event
regexp="(\S+\s+\d+\s+\d\d:\d\d:\d\d)\s+(?P<sensor>[^\s]*).*?ssh.*?Invalid user (?P<user>\S+) from (?P<src>\IPV4)"
plugin_sid=3
sensor={resolv($sensor)}
date={normalize_date($1)}
src_ip={$src}
username={$user}


[ssh - Illegal user]
# Jan  7 16:36:07 hostname sshd[25119]: Illegal user rolo from 192.168.2.1 
event_type=event
regexp="(\S+\s+\d+\s+\d\d:\d\d:\d\d)\s+(?P<sensor>[^\s]*).*?ssh.*?Illegal user (?P<user>\S+) from (?P<src>\IPV4)"
plugin_sid=4
sensor={resolv($sensor)}
date={normalize_date($1)}
src_ip={$src}
username={$user}


[ssh - Root login refused]
# Jan  15 01:32:01 ossim-devel sshd[1222]: ROOT LOGIN REFUSED FROM 10.222.3.41
event_type=event
regexp="(\S+\s+\d+\s+\d\d:\d\d:\d\d)\s+(?P<sensor>[^\s]*).*?ssh.*?Root login refused from (?P<src>\IPV4)"
plugin_sid=5
sensor={resolv($sensor)}
date={normalize_date($1)}
src_ip={$src}
username=root

[ssh - User not allowed because listed in DenyUsers]
# Sep  6 11:04:02 ossim-devel sshd[6983]: User piedrahita not allowed because listed
# in DenyUsers
event_type=event
regexp="(\S+\s+\d+\s+\d\d:\d\d:\d\d)\s+(?P<sensor>[^\s]*).*?ssh.*?User (?P<User>\S+) not allowed because listed in Denyusers"
plugin_sid=6
date={normalize_date($1)}
sensor={resolv($sensor)}
username={$user}

##
## Succesfull login attempts
##

[ssh - Login sucessful (Accepted password)]
# Sep  6 10:51:04 ossim-devel sshd[6379]: Accepted password for dgil from
# 10.222.14.12 port 33232 ssh2
event_type=event
regexp="(\S+\s+\d+\s+\d\d:\d\d:\d\d)\s+(?P<sensor>[^\s]*).*?ssh.*?Accepted password for (?P<user>\S+)\s+.*?(?P<src>\IPV4).*?port\s+(?P<sport>\PORT)"
plugin_sid=7
sensor={resolv($sensor)}
date={normalize_date($1)}
src_ip={$src}
src_port={$sport}
username={$user}


[ssh - Login sucessful (Accepted publickey)]
# Sep  5 19:07:51 lolita sshd[14206]: Accepted publickey for alopezp from
# 195.235.*.* port 45602 ssh2
event_type=event
regexp="(\S+\s+\d+\s+\d\d:\d\d:\d\d)\s+(?P<sensor>[^\s]*).*?ssh.*?Accepted publickey for (?P<user>\S+)\s+.*?(?P<src>\IPV4).*?port\s+(?P<sport>\PORT)"
plugin_sid=8
sensor={resolv($sensor)}
date={normalize_date($1)}
src_ip={$src}
src_port={$sport}
username={$user}


##
## Other
##
[ssh - Bad protocol version identification]
# Sep  5 05:01:07 lolita sshd[18931]: Bad protocol version identification
# '\\026\\003' from 208.32.22.22
event_type=event
regexp="(\S+\s+\d+\s+\d\d:\d\d:\d\d)\s+(?P<sensor>[^\s]*).*?ssh.*?Bad protocol version identification .*? from (?P<src>\IPV4)"
plugin_sid=9
date={normalize_date($1)}
sensor={resolv($sensor)}
src_ip={$src}


[ssh - Did not receive identification string]
# Sep  5 05:01:07 lolita sshd[3083]: Did not receive identification string from
# 192.157.2.2
event_type=event
regexp="(\S+\s+\d+\s+\d\d:\d\d:\d\d)\s+(?P<sensor>[^\s]*).*?ssh.*?Did not receive identification string from (?P<src>\IPV4)"
plugin_sid=10
date={normalize_date($1)}
sensor={resolv($sensor)}
src_ip={$src}
