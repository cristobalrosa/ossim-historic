#!/bin/bash

# Repair tables
# Call with a database name in order to repair only one

#
# Cleannig orphans siem tables
#

if [ "$1" == '--orphans' ]; then

    PRE="/usr/share/doc/ossim-mysql/contrib/misc/alienvault_siem_pre_rebuild.sql"
    POST="/usr/share/doc/ossim-mysql/contrib/misc/alienvault_siem_post_rebuild.sql"
    alias df='df'
    alias du='du'
    EXTRA=15000000
    DU=$(du -sc /var/lib/mysql/alienvault_siem/ | tail -1 | awk '{print $1}')
    DU=$(( $DU + $EXTRA ))
    DF=$(df / | tail -1 | awk '{print $4}'| sed 's/%//')
    if [ $DF -lt $DU ]; then
        echo "Not enough free space available. It needs at least $DU MB"
    else
        gunzip /usr/share/doc/ossim-mysql/contrib/misc/*gz 2> /dev/null
        if [ -f "$PRE" ] && [ -f "$POST" ]; then
            echo -n "Preparing tables..."
            cat "$PRE" | ossim-db alienvault_siem
            echo "done."
            echo -n "Fix orphans devices, this may take a while."
            echo "CALL _clean_devices();" | ossim-db alienvault_siem | perl -npe 'BEGIN{$|=1} s/\n//'
            echo "done."
            echo -n "Cleaning orphans, this may take a while."
            echo "CALL _delete_orphans();" | ossim-db alienvault_siem | perl -npe 'BEGIN{$|=1} s/\n//'
            echo "done."
            echo -n "Purging temporary tables..."
            cat "$POST" | ossim-db alienvault_siem
            echo "done."
            echo -n "Verifying counters.."
            CNT=`echo "select count(*) as total from acid_event;" | ossim-db alienvault_siem | tail -1`
            SUM=`echo "select sum(cnt) as total from ac_acid_event;" | ossim-db alienvault_siem | tail -1`
            if [ $SUM == $CNT ]; then
                echo "OK"
            else
                echo "MISSMATCH SUM:$SUM, CNT:$CNT"
            fi
        else
            echo "$PRE or $POST not found"
        fi
    fi
    #
    echo "Finish!"

else
    
    QUERY="SELECT CONCAT(table_schema,'.',table_name) AS table_list FROM information_schema.tables WHERE table_type = 'BASE TABLE' AND engine = 'MyISAM'"
    if [ -z $1 ]; then
      echo Repairing all databases
      echo "-----------------------"
    else
      QUERY="$QUERY AND table_schema = '$1'"
      echo $QUERY
      echo -e "\n[-] Checking $1 database";
    fi
    
    for i in `echo $QUERY | ossim-db | grep -v table_list`; do
        echo -e "\t[+] Repairing $i";
        echo "REPAIR TABLE $i;" | ossim-db
    done

fi
