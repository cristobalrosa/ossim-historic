#!/usr/bin/perl

use DBI;
use ossim_conf;

$| = 1;

my $dsn = 'dbi:mysql:'.$ossim_conf::ossim_data->{"ossim_base"}.':'.$ossim_conf::ossim_data->{"ossim_host"}.':'.  $ossim_conf::ossim_data->{"ossim_port"};
my $dbh = DBI->connect($dsn, $ossim_conf::ossim_data->{"ossim_user"}, $ossim_conf::ossim_data->{"ossim_pass"}) or 
    die "Can't connect to DBI\n";

while (<STDIN>) {

    if (/^\+\s+(\d+\.\d+\.\d+\.\d+) :/) {
        $host = $1; 
        $hv{$host}=0
    }

#if (/^ \. [^(List)]/);

    if (/Risk factor : (.*)/) { 
        $risk=$1; 
	    $risk =~ s/ \(.*|if.*//g; 
	    $risk =~ s/ //g; 
        
	    if ($risk eq "Verylow/none") { $rv=1 }
	    if ($risk eq "Low") { $rv=2 }
	    if ($risk eq "Low/Medium") { $rv=3 }
	    if ($risk eq "Medium/Low") { $rv=4 }
	    if ($risk eq "Medium") { $rv=5 }
	    if ($risk eq "Medium/High") { $rv=6 }
	    if ($risk eq "High/Medium") { $rv=7 }
	    if ($risk eq "High") { $rv=8 }
	    if ($risk eq "Veryhigh") { $rv=9 }

        $hv{$host} += $rv;
    }
}

foreach $key ( keys(%hv) ) {
    
    $ip = $key;
    $vulnerability = $hv{$key};

    print $key, "-", $hv{$key}, "\n";
    
    # delete to update values
    my $query = "DELETE FROM host_vulnerability WHERE ip = '$ip'";
    my $sth = $dbh->prepare($query);
    $sth->execute();

    #
    # update host levels
    # 
    $query = "INSERT INTO host_vulnerability 
                VALUES ('$ip', '$vulnerability');";
    $sth = $dbh->prepare($query);
    $sth->execute();


    #
    # update net levels
    # 
    $vulnerability = 0;
    my $rows = 0;

    $query = "SELECT * FROM net;";
    $sth = $dbh->prepare($query);
    $sth->execute();
    while (my $row = $sth->fetchrow_hashref)
    {
        my $net = $row->{name};

        my $query = "SELECT * FROM net_host_reference WHERE net_name='$net'";
        my $sth = $dbh->prepare($query);
        $sth->execute();
        while (my $row2 = $sth->fetchrow_hashref) {
            my $host_ip = $row2->{host_ip};
            my $query = "SELECT * FROM host_vulnerability
                            WHERE ip = '$host_ip'";
            my $sth = $dbh->prepare($query);
            $sth->execute();
            if (my $row3 = $sth->fetchrow_hashref) {
                $vulnerability += $row3->{vulnerability};
                $rows += 1;
            }
        }
        if ($rows) {
            my $query = "UPDATE net_vulnerability 
                SET vulnerability = $vulnerability
                WHERE net = '$net'";
            my $sth = $dbh->prepare($query);
            $sth->execute();
        }
        $rows = 0;
    }
}

$dbh->disconnect;
exit 0;

