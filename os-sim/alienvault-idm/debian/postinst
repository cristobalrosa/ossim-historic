#!/bin/sh
# postinst script for alienvault-idm
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

configure_db(){
    OSSIM_SETUP_CONF_FILE="/etc/ossim/ossim_setup.conf"
    IDM_CONFIG_XML_FILE="/etc/ossim/idm/config.xml"

    if [ -f "$OSSIM_SETUP_CONF_FILE" ] && [ -f "$IDM_CONFIG_XML_FILE" ]; then
        DB_IP=$(grep "^db_ip=.*" "$OSSIM_SETUP_CONF_FILE" | cut -d "=" -f 2)
        DB_USER=$(grep "^user=.*" "$OSSIM_SETUP_CONF_FILE" | cut -d "=" -f 2)
        DB_PASS=$(grep "^pass=.*" "$OSSIM_SETUP_CONF_FILE" | cut -d "=" -f 2)

        sed -i "s:<datasource name=\"ossimDS\" .*:<datasource name=\"ossimDS\" provider=\"MySQL\" dsn=\"PORT=3306;USER=$DB_USER;PASSWORD=$DB_PASS;DATABASE=alienvault;HOST=$DB_IP\"\/>:" "$IDM_CONFIG_XML_FILE"
        sed -i "s:<datasource name=\"snortDS\" .*:<datasource name=\"snortDS\" provider=\"MySQL\" dsn=\"PORT=3306;USER=$DB_USER;PASSWORD=$DB_PASS;DATABASE=alienvault_siem;HOST=$DB_IP\"\/>:" "$IDM_CONFIG_XML_FILE"
        sed -i "s:<datasource name=\"osvdbDS\" .*:<datasource name=\"osvdbDS\" provider=\"MySQL\" dsn=\"PORT=3306;USER=$DB_USER;PASSWORD=$DB_PASS;DATABASE=alienvault_siem;HOST=$DB_IP\"\/>:" "$IDM_CONFIG_XML_FILE"

        # Update config.xml permissions
        chown avidm:alienvault "$IDM_CONFIG_XML_FILE"
    fi
}

case "$1" in
    configure)
	    if ! getent group alienvault > /dev/null; then
		    addgroup --quiet --system alienvault
	    fi
	    if ! getent passwd avidm > /dev/null; then
		    adduser  --system --ingroup alienvault --gecos "AlienVault IDM" --no-create-home avidm
	    fi
	    [ -d /var/log/alienvault ] || mkdir -p -m 0770 /var/log/alienvault
	    chgrp -R alienvault /var/log/alienvault
	    [ -d /var/log/alienvault/idm ] || mkdir -p -m 0750 /var/log/alienvault/idm
	    chown -R avidm:alienvault /var/log/alienvault/idm

        configure_db

        servercfg="/etc/ossim/server/config.xml"

        if [ -f $servercfg ]; then
            if grep '<idm/>' $servercfg >/dev/null; then
                sed -i 's:<idm/>::' $servercfg
            fi
            if ! grep '<idm mssp=' $servercfg >/dev/null; then
                sed -i 's:</config>:<idm mssp="false"/>\n</config>:' $servercfg
            fi
        fi

        # Add permissions to allow avserver user to read the system_id.
        grep --fixed-strings --quiet "avidm ALL=NOPASSWD: /usr/bin/alienvault-system-id" /etc/sudoers || echo "avidm ALL=NOPASSWD: /usr/bin/alienvault-system-id" >> /etc/sudoers
    ;;

    triggered)
        for trigger in $2
        do
            case "$trigger" in
                alienvault-config-database-ip|alienvault-config-database-pass)
                    configure_db
                    ;;
                *)
                    echo "postinst called with unknown trigger \`$2'">&2
                    exit 1
                ;;
            esac
        done
        ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
